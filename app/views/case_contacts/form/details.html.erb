<div class="title-wrapper">
  <div class="title mb-30 mt-5">
    <div class="align-items-baseline d-md-flex gap-3">
      <h1 class="case-contacts-form-title">
        <%= @case_contact.decorate.form_title %>
      </h1>
      <!-- TODO: remove autosave? -->
      <%# if @autosave %>
      <!-- <small data-autosave-target="alert"></small>-->
      <%# end %>
    </div>
  </div>
</div>

<%= form_with(model: @case_contact, url: wizard_path(nil, case_contact_id: @case_contact.id), local: true, id: "casa-contact-form", class: "component-validated-form") do |form| %>

  <div class="card-style-1 pl-25 mb-10">
    <div class="row align-items-center mb-20">
      <h2 class="col-12 col-md-6 case-contacts-form-subtitle">
        Details
      </h2>
    </div>

    <!-- TODO: confirm error display here? -->
    <%= render "/shared/error_messages", resource: @case_contact %>

    <h4 class="mb-20">
      <label for="case_contact_casa_case">1. Select the relevant <%= "case".pluralize(@casa_cases.count) %> for this contact <span class="red-letter">*</span></label>
    </h4>
    <div class="d-flex flex-column gap-4">
      <%= form.hidden_field :draft_case_ids, multiple: true, value: nil %>
      <%= render "relevant_cases", form: form, options: @casa_cases, selected_items: @selected_cases, casa_cases: @casa_cases %>
    </div>

    <div id="contact-type-form" class="d-flex flex-column gap-4">
      <h4 id="contact-type-label"><label>2. Select All Contact Types</label><span class="red-letter"> *</span></h4>
      <%= render "contact_types", form: form, options: @contact_types, selected_items: @selected_contact_type_ids, casa_cases: @casa_cases %>
    </div>

    <div id="enter-contact-details">
      <h4 class="mb-3"><label>3. Record contact details</label><span class="red-letter"> *</span></h4>
      <div class="">
        <h5 classs="mb-3"><label>a. Was contact made?</label></h5>
        <div class="form-check radio-style mb-20">
          <%= form.radio_button :contact_made, true,
          checked: @case_contact.contact_made,
          required: true,
          class: ["form-check-input", "case-contacts-form-checkbox"] %>
          <%= form.label "Yes", class: "form-check-label", for: "case_contact_contact_made_true" %>
        </div>
        <div class="form-check radio-style mb-20">
          <%= form.radio_button :contact_made, false,
          checked: set_contact_made_false(@case_contact),
          required: true,
          class: ["form-check-input", "case-contacts-form-checkbox"] %>
          <%= form.label "No", class: "form-check-label", for: "case_contact_contact_made_false" %>
        </div>
      </div>

      <div class="field contact-medium form-group">
        <h5 classs="mb-3"><label>b. How was contact made?</label></h5>
        <%= form.collection_radio_buttons(:medium_type, contact_mediums, 'value', 'label') do |b| %>
          <div class="form-check radio-style mb-20">
            <%= b.radio_button(class: ["form-check-input", "case-contacts-form-checkbox"]) %>
            <%= b.label(class: "form-check-label") %>
          </div>
        <% end %>
      </div>

      <div class="pr-50">
        <h5 class="mb-3"><%= form.label :occurred_at, "c. Date of contact" %></h5>
        <div class="input-style-1">
          <!-- TODO: move to controller-->
          <% min_date = CaseContact::MINIMUM_DATE %>
          <% current_date = Date.current %>
          <% initial_value = @case_contact.occurred_at&.to_date || current_date %>
          <%= form.date_field :occurred_at,
          value: initial_value.to_fs(:iso8601),
          max: current_date.to_fs(:iso8601),
          min: min_date.to_fs(:iso8601),
          class: "form-control card-style-1" %>
        </div>
      </div>

      <div class="pr-50 ">
        <h5 class="mb-3"><label>d. Duration of contact</label></h5>
        <%= render(Form::HourMinuteDurationComponent.new(form: form, hour_value: duration_hours(@case_contact), minute_value: duration_minutes(@case_contact))) %>
      </div>
    </div>

    <h4 class="mb-20 details__topics-label">Court Report Topics <span class="content-1">(optional)</span></h4>
    <div>
      <% if @case_contact.contact_topic_answers.any? %>
        <%= form.fields_for(:contact_topic_answers) do |f| %>
          <div class="form-check checkbox-style mb-10 ml-5">
            <%= f.check_box :selected, class: ["form-check-input", "casa-case-id"] %>
            <%= f.label :selected, f.object.contact_topic.question, class: "form-check-label" %>
          </div>
        <% end %>
      <% elsif current_user.casa_admin? %>
        Visit <%= link_to "Manage Case Contact Topics", edit_casa_org_path(current_user.casa_org_id) %> to set your organization Court report topics.
      <% else %>
        Your organization has not set any Court Report Topics yet. Contact your admin to learn more.
      <% end %>
    </div>
  </div>

  <div data-controller="autosave" data-autosave-good-alert-class="text-muted" data-autosave-bad-alert-class="text-danger">
    <div data-controller="autosave" data-autosave-good-alert-class="text-muted" data-autosave-bad-alert-class="text-danger">
      <%= render("contact_topic_notes", form:) %>

      <div class="card-style-1 pl-25 pr-25 mb-10">
        <div class="d-flex justify-content-between mb-3"
          data-icon-toggle-target="margin"
          data-action="click->icon-toggle#toggle"
          data-bs-toggle="collapse"
          data-controller="icon-toggle"
          data-bs-target="#additional-notes"
          data-icon-toggle-icons-value='["lni-chevron-up", "lni-chevron-down"]'>
          <h4 class=""><%= form.label :notes, "#{@case_contact.contact_topic_answers.count + 1}. Additional notes (optional)" %></h4>
          <button class="bg-transparent border-0"
            type="button"
            aria-expanded="false">
            <i id="additional-notes-icon" class="lni lni-chevron-up" data-icon-toggle-target="icon"></i>
          </button>
        </div>

        <div class="collapse show" id="additional-notes">
          <p class="mb-3">
            Include any additional comments or notes that may assist in future case tracking or reporting.
          </p>
          <div class="input-style-1">
            <%= form.text_area :notes, :rows => 5, placeholder: "Additional notes", class: "form-control", data: { action: "input->autosave#save" } %>
          </div>
        </div>
      </div>
    </div>
    <!-- TODO: move to controller? -->
    <% if Flipper.enabled?(:reimbursement_warning, current_organization) %>
      <article class="card-style-1 pl-25 mb-10 pr-50" style="background-color: #fcab553d;">
        <h4 class="mb-3"><label>Volunteers are eligible to be reimbursed for case-related travel.</label></h4>
        <span> Volunteers are reimbursed at the federal mileage rate.</span>
        <br>
        <span>Please note that there is a $35.00 per month cap per volunteer for your mileage.</span>
        <span>We aim to mail your reimbursement to you via check within 14-28 business days of your request for reimbursement.</span>
      </article>
    <% end %>

    <div class="card-style-1 pl-25 mb-10 pr-50">
      <div class="d-flex gap-1">
        <h4 class="mb-3"><label>1. Travel Details</label></h4>
        <p class="text-dark">(optional)</p>
      </div>

      <!-- TODO: move to controller? -->
      <% if current_organization.show_driving_reimbursement && show_volunteer_reimbursement(@casa_cases) %>
        <div class="field want-driving-reimbursement form-group">
          <h5 class="mb-3"><label>a. Do you require driving reimbursement for this case contact?</label></h5>
          <div class="form-check radio-style mb-20">
            <%= form.radio_button :want_driving_reimbursement, true, required: false, class: ["form-check-input", "case-contacts-form-checkbox"] %>
            <%= form.label "Yes", class: "form-check-label", for: "case_contact_want_driving_reimbursement_true" %>
          </div>
          <div class="form-check radio-style mb-20">
            <%= form.radio_button :want_driving_reimbursement, false, required: false, class: ["form-check-input", "case-contacts-form-checkbox"] %>
            <%= form.label "No", class: "form-check-label", for: "case_contact_want_driving_reimbursement_false" %>
          </div>
        </div>

        <div class="field miles-driven form-group">
          <h5 class="mb-3"><%= form.label :miles_driven, "b. Total miles driven" %></h5>
          <div class="input-style-1">
            <!-- TODO: move to controller? -->
            <% if form.object.new_record? && @case_contact.miles_driven == 0 %>
              <input class="form-control" min="0" max="10000" type="number" value="0" name="case_contact[miles_driven]" autocomplete="off" id="case_contact_miles_driven">
            <% else %>
              <%= form.number_field :miles_driven, class: "form-control", min: "0", max: 10000, placeholder: "0" %>
            <% end %>
          </div>
        </div>

        <div class="field volunteer-address form-group">
          <h5 class="mb-3"><label>c. Your current address (for reimbursement check)</label></h5>
          <div class="input-style-1 mb-0">
            <%= form.text_field :volunteer_address, value: @case_contact.decorate.address_of_volunteer, disabled: @case_contact.address_field_disabled?, class: "input-style-1" %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- ADDITIONAL EXPENSES -->
    <!-- TODO: move to controller? -->
    <% if Pundit.policy(current_user, @case_contact).additional_expenses_allowed? %>
      <div class="card-style-1 pl-25 mb-10 pr-50">
        <div class="d-flex gap-1">
          <h4 class="mb-3"><label>2. Other Expenses</label></h4>
          <p class="text-dark">(optional)</p>
        </div>

        <div class="other-expenses">
          <ol>
            <!-- TODO: what does this do? -->
            <% @case_contact.decorate.additional_expenses_count %>
            <% if form.object.additional_expenses.any? %>
              <% form.object.additional_expenses.each do |expense| %>
                <%= form.fields_for :additional_expenses, expense do |f| %>
                  <%= render "shared/additional_expense_form", form: f, new_record: false %>
                <% end %>
              <% end %>
            <% else %>
              <%= form.fields_for :additional_expenses, AdditionalExpense.new do |f| %>
                <%= render "shared/additional_expense_form", form: f, new_record: true %>
              <% end %>
            <% end %>
            <template data-nested-form-target="template">
              <%= form.fields_for :additional_expenses, AdditionalExpense.new, child_index: "NEW_RECORD" do |f| %>
                <%= render "shared/additional_expense_form", form: f %>
              <% end %>
            </template>
            <div data-nested-form-target="target"></div>
          </ol>

          <button type="button" class="btn-sm main-btn primary-btn-outline btn-hover" data-action="nested-form#add" id="add-another-expense">
            <i class="lni lni-plus mr-10"></i> Add Another Expense
          </button>
        </div>
      </div>
    <% end %>
    <div class="actions mb-10 case-contacts-form-buttons">
      <div class="checkbox-style pt-1">
        <%= form.fields_for :metadata do |metadata_form| %>
          <%= metadata_form.check_box :create_another, class: "form-check-input" %>
          <%= metadata_form.label :create_another, class: "form-check-label d-inline align-bottom" do %>
            Create Another
            <i class="lni lni-question-circle" data-toggle="tooltip" data-placement="top" title="Start a new contact for the same case(s) after submitting.">
            </i>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
  <!--  </div> -->
  <div class="actions mb-10 case-contacts-form-buttons">
    <div class="actions mb-10 case-contacts-form-buttons">
      <%= link_to leave_case_contacts_form_path, class: "btn-sm main-btn #{@case_contact.draft_case_ids.empty? ? 'danger' : 'primary'}-btn-outline btn-hover", data: { controller: "alert", "action": "alert#confirm", "alert-ignore-value": !@case_contact.draft_case_ids.empty?, "alert-title-value": "Discard draft?", "alert-message-value": "Are you sure? If you don't save and continue to the next step, this draft will not be recoverable." } do %>
        Back
      <% end %>

      <%= render(Form::SubmitButtonComponent.new(last_step: nil, current_step: :details)) %>
    </div>
  </div>
<% end %>
